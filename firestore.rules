rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }

    // 相手(uid)のfriendsに自分がいるか（友達判定）
    function isFriend(uid) {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(uid)/friends/$(request.auth.uid));
    }

    // デフォルト拒否
    match /{document=**} {
      allow read, write: if false;
    }

    // ===== 検索・他人表示用 公開プロフィール =====
    // ここだけ検索で読む。公開して良い情報だけ置く（表示名・性別・夢・公開フラグ等）
    match /publicUsers/{uid} {
      allow read: if signedIn();        // アプリ利用者（ログイン者）なら検索できる
      allow create, update, delete: if isOwner(uid);
    }

    // ===== 本人領域（プライベート）=====
    match /users/{uid} {
      // users本体は本人だけ（ここを開けないのが安全の核）
      allow read, write: if isOwner(uid);

      // ログイン状況っぽい表示（簡易）: users/{uid}/public/status
      match /public/status {
        allow read: if signedIn();      // 表示したいなら
        allow write: if isOwner(uid);   // 更新は本人だけ
      }

      // 申請（受信箱方式）: users/{toUid}/friendRequests/{reqId}
      match /friendRequests/{reqId} {
        allow read, delete: if isOwner(uid);

        // 申請作成（最低限の整合性）
        allow create: if signedIn()
          && request.resource.data.fromUid == request.auth.uid
          && request.resource.data.toUid == uid
          && request.resource.data.status == "pending";

        // 承認/拒否は受信者だけ
        allow update: if isOwner(uid);
      }

      // friends：本人だけが作る/消す（勝手に友達化できない）
      match /friends/{friendUid} {
        allow read: if isOwner(uid);
        allow create, update, delete: if isOwner(uid);
      }

      // goals：公開設定（visibility）で読める範囲を変える。編集は本人だけ。
      match /goals/{goalId} {
        allow create, update, delete: if isOwner(uid);

        allow read: if isOwner(uid)
          || (resource.data.visibility == "friends" && isFriend(uid))
          || (resource.data.visibility == "public" && signedIn());
      }

      // habits/todos：本人だけ（公開したければgoalsと同じvisibility方式にする）
      match /habits/{habitId} {
        allow read, write: if isOwner(uid);
      }

      match /todos/{todoId} {
        allow read, write: if isOwner(uid);
      }

      // 通知（最小）：本人だけ読む/消す。作成は本人のみ（将来Functions化推奨）
      match /notifications/{notiId} {
        allow read, delete: if isOwner(uid);
        allow create: if isOwner(uid);
        allow update: if false;
      }
    }
  }
}
